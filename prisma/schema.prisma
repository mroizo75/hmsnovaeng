// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// Auth & Tenant Management
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String       @unique
  emailVerified DateTime?
  image         String?      // Avatar/profilbilde
  password      String?
  isSuperAdmin  Boolean      @default(false)
  isSupport     Boolean      @default(false) // Support rolle: kan kun administrere tenants
  lastTenantId  String?      // Siste valgte tenant for brukere med flere tenants
  
  // Kontaktinformasjon
  phone         String?      // Telefonnummer
  address       String?      // Adresse
  postalCode    String?      // Postnummer
  city          String?      // Poststed
  
  // Varslingsinnstillinger
  notifyByEmail       Boolean  @default(true)  // Motta e-postvarsler
  notifyBySms         Boolean  @default(false) // Motta SMS-varsler (krever phone)
  reminderDaysBefore  Int      @default(1)     // Hvor mange dager før hendelser skal varsles
  notifyMeetings      Boolean  @default(true)  // Varsle om møter
  notifyInspections   Boolean  @default(true)  // Varsle om vernerunder/inspeksjoner
  notifyAudits        Boolean  @default(true)  // Varsle om revisjoner
  notifyMeasures      Boolean  @default(true)  // Varsle om tiltak som forfaller
  notifyIncidents     Boolean  @default(true)  // Varsle om avvik/hendelser
  notifyDocuments     Boolean  @default(true)  // Varsle om dokumenter
  notifyTraining      Boolean  @default(true)  // Varsle om opplæring
  notifyRisks         Boolean  @default(true)  // Varsle om risikoer
  dailyDigest         Boolean  @default(false) // Motta daglig e-post sammendrag
  weeklyDigest        Boolean  @default(true)  // Motta ukentlig e-post sammendrag
  
  // Security: Account lockout
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAttempt    DateTime?
  
  accounts            Account[]
  sessions            Session[]
  tenants             UserTenant[]
  blogPosts           BlogPost[]   // Blogg-artikler skrevet av bruker
  passwordResetTokens PasswordResetToken[]
  meetingParticipants MeetingParticipant[] @relation("MeetingParticipants")
  meetingDecisions    MeetingDecision[]    @relation("MeetingDecisions")
  documentsApproved   Document[]           @relation("DocumentApprovedBy")
  ownedDocuments      Document[]           @relation("DocumentOwner")
  ownedRisks          Risk[]               @relation("RiskOwner")
  riskControlsOwned   RiskControl[]        @relation("RiskControlOwner")
  securityAssetsOwned SecurityAsset[]      @relation("SecurityAssetOwner")
  securityControlsOwned SecurityControl[]  @relation("SecurityControlOwner")
  securityEvidenceCollected SecurityEvidence[] @relation("SecurityEvidenceCollector")
  environmentalAspects EnvironmentalAspect[] @relation("EnvironmentalAspectOwner")
  measures            Measure[]            @relation("MeasureResponsible")
  environmentalMeasurements EnvironmentalMeasurement[] @relation("EnvironmentalMeasurementResponsible")
  accessReviewsOwned  AccessReview[]       @relation("AccessReviewOwner")
  accessReviewDecisions AccessReviewEntry[] @relation("AccessReviewDecider")
  feedbackRecorded    CustomerFeedback[]   @relation("FeedbackRecorder")
  feedbackFollowUp    CustomerFeedback[]   @relation("FeedbackFollowUpOwner")
  notifications       Notification[]
  scheduledReminders  ScheduledReminder[]  @relation("UserReminders")
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([email])
  @@index([isSuperAdmin])
  @@index([isSupport])
  @@index([lockedUntil])
  @@index([emailVerified])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?  @db.Text
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@index([expires])
}

model Tenant {
  id               String           @id @default(cuid())
  name             String
  orgNumber        String?
  slug             String           @unique
  status           TenantStatus     @default(TRIAL)
  trialEndsAt      DateTime?
  contactEmail     String?
  contactPhone     String?
  address          String?
  city             String?
  postalCode       String?
  fikenCompanyId   String?          @unique
  
  // Fakturainformasjon
  invoiceEmail     String?          // E-post for faktura
  useEHF           Boolean          @default(false) // Mottar EHF-fakturaer
  invoiceAddress   String?          // Faktura-adresse (hvis ikke EHF)
  invoicePostalCode String?         // Postnummer (hvis ikke EHF)
  invoiceCity      String?          // Poststed (hvis ikke EHF)
  
  // CRM/Onboarding fields
  employeeCount    Int?             // Antall ansatte
  pricingTier      PricingTier?     // Prisklasse basert på ansatte
  industry         String?          // Bransje
  contactPerson    String?          // Kontaktperson
  notes            String?          @db.Text // CRM-notater
  onboardingStatus OnboardingStatus @default(NOT_STARTED)
  onboardingCompletedAt DateTime?
  salesRep         String?          // Selger/support ansvarlig
  
  // HMS-kontaktinformasjon (dynamisk visning for ansatte)
  hmsContactName   String?          // Navn på HMS-ansvarlig
  hmsContactPhone  String?          // Telefon til HMS-ansvarlig
  hmsContactEmail  String?          // E-post til HMS-ansvarlig
  
  // Azure AD / Office 365 SSO Integration (per-tenant)
  azureAdTenantId     String?       // Azure AD Tenant ID (fra Azure Portal)
  azureAdEnabled      Boolean       @default(false) // Er Azure AD SSO aktivert?
  azureAdSyncEnabled  Boolean       @default(false) // Auto-sync brukere fra Azure AD?
  azureAdLastSync     DateTime?     // Sist synkronisert
  azureAdDomain       String?       // Primary domain (f.eks. "firma.no")
  azureAdAutoRole     Role?         // Standard rolle for nye brukere fra Azure AD
  
  users            UserTenant[]
  documents        Document[]
  documentVersions DocumentVersion[]
  documentTemplates DocumentTemplate[]
  risks            Risk[]
  riskAssessments  RiskAssessment[]
  riskControls     RiskControl[]
  riskDocumentLinks RiskDocumentLink[]
  riskAuditLinks   RiskAuditLink[]
  riskChemicalLinks RiskChemicalLink[]
  riskTrainingRequirements RiskTrainingRequirement[]
  securityAssets   SecurityAsset[]
  securityControls SecurityControl[]
  securityControlDocuments SecurityControlDocument[]
  securityEvidences SecurityEvidence[]
  accessReviews    AccessReview[]
  accessReviewEntries AccessReviewEntry[]
  customerFeedbacks CustomerFeedback[]
  incidents        Incident[]
  trainings        Training[]
  courseTemplates  CourseTemplate[]
  actions          Measure[]
  environmentalAspects EnvironmentalAspect[]
  environmentalMeasurements EnvironmentalMeasurement[]
  audits           Audit[]
  goals            Goal[]
  chemicals        Chemical[]
  attachments      Attachment[]
  auditLogs        AuditLog[]
  subscription     Subscription?
  invoices         Invoice[]
  formTemplates    FormTemplate[]   // Digital forms
  notifications    Notification[]
  formSubmissions  FormSubmission[] // Digital forms
  kpiMeasurements  KpiMeasurement[] // KPI målinger
  inspections      Inspection[]     // Vernerunde/Inspeksjoner
  inspectionTemplates InspectionTemplate[]
  managementReviews ManagementReview[] // Ledelsens gjennomgang
  meetings         Meeting[]        // AMU/VO møter
  whistleblowings  Whistleblowing[] // Varslinger
  scheduledReminders ScheduledReminder[] // Planlagte påminnelser
  bhtClient        BhtClient?       // BHT-kunde (hvis aktivert)
  navigationItems  NavigationItem[] // Meny-konfigurasjoner
  simpleMenuItems  Json?            // Hrefs som vises i enkel meny (null = standard)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([status])
  @@index([fikenCompanyId])
  @@index([pricingTier])
  @@index([onboardingStatus])
}

enum TenantStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum PricingTier {
  MICRO      // 1-20 ansatte (Små bedrifter: 6.000 kr/år)
  SMALL      // 21-50 ansatte (Mellomstore bedrifter: 8.000 kr/år)
  MEDIUM     // 51+ ansatte (Store bedrifter: 12.000 kr/år)
  LARGE      // Legacy tier (ikke i bruk)
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  ADMIN_CREATED
  DOCUMENTS_UPLOADED
  TRAINING_SCHEDULED
  COMPLETED
}

// ═══════════════════════════════════════════════════════════════
// HMS DOCUMENT GENERATOR
// ═══════════════════════════════════════════════════════════════

model GeneratedDocument {
  id            String   @id @default(cuid())
  email         String
  companyName   String
  orgNumber     String?
  industry      Industry
  employees     Int
  
  // Contact info
  ceoName       String
  address       String?
  postalCode    String?
  city          String?
  phone         String?
  
  // HMS Organization
  hmsResponsible String?
  hmsEmail      String?
  hmsPhone      String?
  safetyRep     String?
  safetyRepEmail String?
  safetyRepPhone String?
  hasBHT        Boolean @default(false)
  bhtProvider   String?
  bhtContact    String?
  
  // Departments (JSON array)
  departments   Json?
  
  // Training (JSON array of completed training)
  completedTraining Json?
  
  // Additional info
  companyDescription String? @db.Text
  
  // Generated files (R2 keys)
  registerKey   String?  // HMS-00: Register over HMS-dokumenter
  handbookKey   String?  // HMS-01: HMS-Håndbok
  riskKey       String?  // HMS-02: Risikovurdering
  trainingKey   String?  // HMS-03: Opplæringsplan
  vernerundeKey String?  // HMS-04: Vernerunde / Sjekkliste
  amuKey        String?  // HMS-05: AMU møteprotokoll
  zipKey        String?  // Komplett pakke med alle dokumenter
  
  // Meta
  status        GenerationStatus @default(PENDING)
  generatedAt   DateTime?
  downloadCount Int     @default(0)
  lastDownloadAt DateTime?
  convertedToTrial Boolean @default(false)
  convertedAt   DateTime?
  
  // Marketing consent
  marketingConsent Boolean @default(false)
  
  // Newsletter tracking
  newsletterSubscribed Boolean @default(false) // Hvis de ønsker nyhetsbrev
  lastNewsletterSent  DateTime? // Siste nyhetsbrev sendt
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([email])
  @@index([industry])
  @@index([status])
  @@index([createdAt])
  @@index([convertedToTrial])
  @@index([newsletterSubscribed])
}

enum GenerationStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum Industry {
  CONSTRUCTION      // Bygg og anlegg
  HEALTHCARE        // Helsevesen
  TRANSPORT         // Transport og logistikk
  MANUFACTURING     // Industri og produksjon
  RETAIL            // Handel og service
  HOSPITALITY       // Hotell og restaurant
  EDUCATION         // Utdanning
  TECHNOLOGY        // Teknologi og IT
  AGRICULTURE       // Landbruk
  OTHER             // Annet
}

model Subscription {
  id              String            @id @default(cuid())
  tenantId        String            @unique
  plan            SubscriptionPlan
  status          SubscriptionStatus @default(ACTIVE)
  price           Float
  billingInterval BillingInterval   @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean        @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
}

enum SubscriptionPlan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

model Invoice {
  id              String        @id @default(cuid())
  tenantId        String
  fikenInvoiceId  String?       @unique
  invoiceNumber   String?
  amount          Float
  dueDate         DateTime
  paidDate        DateTime?
  status          InvoiceStatus @default(PENDING)
  period          String?       // "2025-01"
  description     String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([fikenInvoiceId])
}

enum InvoiceStatus {
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model UserTenant {
  id         String   @id @default(cuid())
  userId     String
  tenantId   String
  role       Role
  department String?
  
  // Tenant-spesifikke brukerinnstillinger (kan være ulike per tenant)
  displayName  String?      // Visningsnavn i denne tenanten (kan være annerledes enn User.name)
  phone        String?      // Telefonnummer for denne tenanten
  
  // Varslingsinnstillinger (per tenant)
  notifyByEmail       Boolean  @default(true)  // Motta e-postvarsler
  notifyBySms         Boolean  @default(false) // Motta SMS-varsler (krever phone)
  reminderDaysBefore  Int      @default(1)     // Hvor mange dager før hendelser skal varsles
  notifyMeetings      Boolean  @default(true)  // Varsle om møter
  notifyInspections   Boolean  @default(true)  // Varsle om vernerunder/inspeksjoner
  notifyAudits        Boolean  @default(true)  // Varsle om revisjoner
  notifyMeasures      Boolean  @default(true)  // Varsle om tiltak som forfaller
  notifyIncidents     Boolean  @default(true)  // Varsle om avvik/hendelser
  notifyDocuments     Boolean  @default(true)  // Varsle om dokumenter
  notifyTraining      Boolean  @default(true)  // Varsle om opplæring
  notifyRisks         Boolean  @default(true)  // Varsle om risikoer
  dailyDigest         Boolean  @default(false) // Motta daglig e-post sammendrag
  weeklyDigest        Boolean  @default(true)  // Motta ukentlig e-post sammendrag

  // Import: null = ikke sendt invitasjon (vis «Aktiver»); satt = invitasjon sendt
  invitationSentAt    DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

enum Role {
  ADMIN
  HMS
  LEDER
  VERNEOMBUD
  ANSATT
  BHT
  REVISOR
}

// ============================================
// Document Management (MED VERSJONERING)
// ============================================

model Document {
  id         String       @id @default(cuid())
  tenantId   String
  kind       DocumentKind
  title      String
  slug       String
  version    String       // Gjeldende versjon (v1.0, v1.1, v2.0)
  status     DocStatus    @default(DRAFT)
  fileKey    String       // Gjeldende fil
  mime       String       @default("application/pdf") // MIME-type (f.eks. application/pdf, application/vnd.openxmlformats-officedocument.wordprocessingml.document)
  approvedBy String?
  approvedAt DateTime?
  updatedBy  String?
  ownerId    String?
  templateId String?
  nextReviewDate DateTime? // Når skal dokumentet gjennomgås igjen?
  reviewIntervalMonths Int @default(12)
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  planSummary   String?    @db.Text
  doSummary     String?    @db.Text
  checkSummary  String?    @db.Text
  actSummary    String?    @db.Text
  visibleToRoles Json?    // Array av roller som skal se dokumentet ["ANSATT", "LEDER"]. Null = alle
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  versions        DocumentVersion[] // Historikk av alle versjoner
  approvedByUser  User?             @relation("DocumentApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)
  owner           User?             @relation("DocumentOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  template        DocumentTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  riskDocumentLinks RiskDocumentLink[]
  riskControlsEvidence RiskControl[] @relation("RiskControlEvidence")
  securityControlDocuments SecurityControlDocument[]

  @@unique([tenantId, slug]) // Slug må være unik per tenant
  @@index([tenantId])
  @@index([status])
  @@index([nextReviewDate])
}

// Versjonshåndtering - ALLE versjoner lagres
model DocumentVersion {
  id              String    @id @default(cuid())
  tenantId        String
  documentId      String
  version         String    // v1.0, v1.1, v2.0
  fileKey         String    // Fil for denne versjonen
  mime            String    @default("application/pdf") // MIME-type for denne versjonen
  changeComment   String?   @db.Text // Hva ble endret?
  uploadedBy      String
  approvedBy      String?
  approvedAt      DateTime?
  supersededAt    DateTime? // Når ble denne erstattet av ny versjon?
  createdAt       DateTime  @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([version])
}

enum DocumentKind {
  LAW
  PROCEDURE
  CHECKLIST
  FORM
  SDS
  PLAN
  OTHER
}

enum DocStatus {
  DRAFT      // Nytt dokument, ikke godkjent
  APPROVED   // Godkjent og aktivt
  ARCHIVED   // Utdatert/erstattet
}

model DocumentTemplate {
  id           String   @id @default(cuid())
  tenantId     String?
  name         String
  category     String?
  description  String?  @db.Text
  pdcaGuidance Json?
  defaultReviewIntervalMonths Int @default(12)
  isGlobal     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant   Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  documents Document[]

  @@index([tenantId])
  @@index([isGlobal])
}

// ============================================
// Risk Management
// ============================================

/// Årlig eller periodisk risikovurdering (f.eks. "Risikovurdering 2026"). ISO 45001: systematisk vurdering med identifiserte risikopunkter.
model RiskAssessment {
  id             String   @id @default(cuid())
  tenantId       String
  title          String   // f.eks. "Risikovurdering 2026"
  assessmentYear Int      // år (2026)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  risks  Risk[]

  @@index([tenantId])
  @@index([assessmentYear])
}

model Risk {
  id          String     @id @default(cuid())
  tenantId    String
  riskAssessmentId String? // tilhører en risikovurdering (årlig dokument)
  title       String
  context     String     @db.Text
  likelihood  Int
  consequence Int
  score       Int
  ownerId     String
  status      RiskStatus @default(OPEN)
  category    RiskCategory @default(OPERATIONAL)
  location    String?
  area        String?
  description String?   @db.Text
  existingControls String? @db.Text
  residualLikelihood Int?
  residualConsequence Int?
  residualScore Int?
  nextReviewDate DateTime?
  controlFrequency ControlFrequency? @default(ANNUAL)
  riskStatement String? @db.Text
  kpiId        String?
  inspectionTemplateId String?
  linkedProcess String?
  riskAppetite String? @db.Text
  riskTolerance String? @db.Text
  responseStrategy RiskResponseStrategy @default(REDUCE)
  trend        RiskTrend @default(STABLE)
  reviewedAt  DateTime?
  assessmentDate DateTime? // vurderingsdato for dette punktet (i listen)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  tenant              Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  riskAssessment      RiskAssessment?    @relation(fields: [riskAssessmentId], references: [id], onDelete: SetNull)
  measures            Measure[]
  owner               User               @relation("RiskOwner", fields: [ownerId], references: [id])
  kpi                 Goal?              @relation("RiskGoal", fields: [kpiId], references: [id])
  inspectionTemplate  InspectionTemplate? @relation("RiskInspectionTemplate", fields: [inspectionTemplateId], references: [id])
  linkedIncidents     Incident[]         @relation("IncidentRiskReference")
  inspectionFindings  InspectionFinding[] @relation("InspectionFindingRisk")
  documentLinks       RiskDocumentLink[]
  auditLinks          RiskAuditLink[]
  controls            RiskControl[]
  securityControls    SecurityControl[]
  chemicalLinks       RiskChemicalLink[]
  trainingRequirements RiskTrainingRequirement[]

  @@index([tenantId])
  @@index([riskAssessmentId])
  @@index([status])
  @@index([score])
  @@index([category])
  @@index([nextReviewDate])
  @@index([kpiId])
  @@index([inspectionTemplateId])
}

enum RiskStatus {
  OPEN
  MITIGATING
  ACCEPTED
  CLOSED
}

enum RiskCategory {
  STRATEGIC
  OPERATIONAL
  SAFETY
  HEALTH
  ENVIRONMENTAL
  LEGAL
  INFORMATION_SECURITY
  // Arbeidsmiljø (ISO 45001) – typiske kategorier i årlig risikovurdering
  PSYCHOSOCIAL   // Psykososialt
  ERGONOMIC      // Ergonomisk
  ORGANISATIONAL // Organisatorisk
  PHYSICAL       // Fysisk
}

enum RiskResponseStrategy {
  AVOID
  REDUCE
  TRANSFER
  ACCEPT
}

enum RiskTrend {
  INCREASING
  STABLE
  DECREASING
}

enum RiskDocumentRelation {
  SUPPORTING
  POLICY
  PROCEDURE
  CONTROL_REPORT
  WORK_INSTRUCTION
  OTHER
}

enum RiskAuditRelation {
  CONTROL_TEST
  FOLLOW_UP
  OBSERVATION
  OTHER
}

enum RiskControlType {
  PREVENTIVE
  DETECTIVE
  CORRECTIVE
  DIRECTIONAL
  COMPENSATING
}

enum RiskControlStatus {
  ACTIVE
  NEEDS_IMPROVEMENT
  RETIRED
}

enum RiskControlEffectiveness {
  EFFECTIVE
  PARTIAL
  INEFFECTIVE
  NOT_TESTED
}

model RiskDocumentLink {
  id         String                @id @default(cuid())
  tenantId   String
  riskId     String
  documentId String
  relation   RiskDocumentRelation  @default(SUPPORTING)
  note       String?               @db.Text
  createdAt  DateTime              @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  risk     Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([riskId, documentId])
  @@index([tenantId])
  @@index([documentId])
}

model RiskAuditLink {
  id        String             @id @default(cuid())
  tenantId  String
  riskId    String
  auditId   String
  relation  RiskAuditRelation  @default(CONTROL_TEST)
  summary   String?            @db.Text
  createdAt DateTime           @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)
  audit  Audit  @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@unique([riskId, auditId])
  @@index([tenantId])
  @@index([auditId])
}

model RiskControl {
  id                 String                   @id @default(cuid())
  tenantId           String
  riskId             String
  title              String
  description        String?                  @db.Text
  controlType        RiskControlType          @default(PREVENTIVE)
  ownerId            String?
  status             RiskControlStatus        @default(ACTIVE)
  effectiveness      RiskControlEffectiveness @default(NOT_TESTED)
  frequency          ControlFrequency?
  lastTestedAt       DateTime?
  nextTestDate       DateTime?
  monitoringMethod   String?
  evidenceDocumentId String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  risk              Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  owner             User?    @relation("RiskControlOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  evidenceDocument  Document? @relation("RiskControlEvidence", fields: [evidenceDocumentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([riskId])
  @@index([ownerId])
  @@index([controlType])
  @@index([status])
}

// ============================================
// Risk → Chemical Linking (ISO 45001 / 14001)
// ============================================

model RiskChemicalLink {
  id          String        @id @default(cuid())
  tenantId    String
  riskId      String
  chemicalId  String
  exposure    ExposureLevel @default(MEDIUM)
  ppRequired  Boolean       @default(false) // Personlig verneutstyr påkrevd
  note        String?       @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  risk     Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  chemical Chemical @relation(fields: [chemicalId], references: [id], onDelete: Cascade)

  @@unique([riskId, chemicalId])
  @@index([tenantId])
  @@index([chemicalId])
  @@index([exposure])
}

enum ExposureLevel {
  LOW      // Minimal eksponering - lav risiko
  MEDIUM   // Moderat eksponering - standard sikkerhetstiltak
  HIGH     // Høy eksponering - krever ekstra tiltak og overvåking
  CRITICAL // Kritisk eksponering - CMR, diisocyanater, SVHC (krever spesialtiltak)
}

// ============================================
// Risk → Training Requirement (ISO 45001: 7.2)
// ============================================

model RiskTrainingRequirement {
  id          String   @id @default(cuid())
  tenantId    String
  riskId      String
  courseKey   String   // Nøkkel fra CourseTemplate (f.eks. "diisocyanate-handling")
  isMandatory Boolean  @default(true) // Obligatorisk opplæring
  reason      String?  @db.Text // Begrunnelse (f.eks. "EU REACH Annex XVII")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@unique([riskId, courseKey])
  @@index([tenantId])
  @@index([courseKey])
}

enum ControlFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  BIENNIAL
}

enum SecurityAssetType {
  INFORMATION_SYSTEM
  APPLICATION
  INFRASTRUCTURE
  DOCUMENT
  PEOPLE
  FACILITY
  OTHER
}

enum CIAValue {
  LOW
  MEDIUM
  HIGH
}

enum SecurityControlCategory {
  ORGANIZATIONAL
  PEOPLE
  PHYSICAL
  TECHNICAL
}

enum SecurityControlStatus {
  PLANNED
  IN_PROGRESS
  IMPLEMENTED
  LIVE
}

enum SecurityControlMaturity {
  INITIAL
  MANAGED
  DEFINED
  OPTIMIZED
}

enum AccessReviewStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
}

enum AccessDecision {
  REVIEW
  APPROVED
  REVOKED
}

enum FeedbackSource {
  EMAIL
  PHONE
  MEETING
  SURVEY
  SOCIAL
  OTHER
}

enum FeedbackSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum FeedbackStatus {
  NEW
  ACKNOWLEDGED
  SHARED
  FOLLOW_UP
  CLOSED
}

model SecurityAsset {
  id                   String          @id @default(cuid())
  tenantId             String
  name                 String
  description          String?         @db.Text
  type                 SecurityAssetType @default(INFORMATION_SYSTEM)
  ownerId              String?
  confidentiality      CIAValue        @default(MEDIUM)
  integrity            CIAValue        @default(MEDIUM)
  availability         CIAValue        @default(MEDIUM)
  businessCriticality  Int?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner  User?  @relation("SecurityAssetOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  controls SecurityControl[]

  @@index([tenantId])
  @@index([ownerId])
}

model SecurityControl {
  id                String                   @id @default(cuid())
  tenantId          String
  code              String
  title             String
  requirement       String?                  @db.Text
  annexReference    String?
  category          SecurityControlCategory  @default(ORGANIZATIONAL)
  status            SecurityControlStatus    @default(PLANNED)
  maturity          SecurityControlMaturity  @default(INITIAL)
  ownerId           String?
  linkedAssetId     String?
  linkedRiskId      String?
  implementationNote String?                 @db.Text
  monitoring        String?                  @db.Text
  lastTestDate      DateTime?
  nextReviewDate    DateTime?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner       User?         @relation("SecurityControlOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  linkedAsset SecurityAsset? @relation(fields: [linkedAssetId], references: [id], onDelete: SetNull)
  linkedRisk  Risk?         @relation(fields: [linkedRiskId], references: [id], onDelete: SetNull)
  evidences   SecurityEvidence[]
  documents   SecurityControlDocument[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([ownerId])
  @@index([linkedAssetId])
  @@index([linkedRiskId])
}

model SecurityControlDocument {
  id         String      @id @default(cuid())
  tenantId   String
  controlId  String
  documentId String
  note       String?     @db.Text
  createdAt  DateTime    @default(now())

  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  control  SecurityControl @relation(fields: [controlId], references: [id], onDelete: Cascade)
  document Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([controlId, documentId])
  @@index([documentId])
}

model SecurityEvidence {
  id             String      @id @default(cuid())
  tenantId       String
  controlId      String
  title          String
  description    String?     @db.Text
  attachmentKey  String?
  collectedById  String?
  collectedAt    DateTime    @default(now())
  reviewResult   String?
  createdAt      DateTime    @default(now())

  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  control     SecurityControl @relation(fields: [controlId], references: [id], onDelete: Cascade)
  collectedBy User?           @relation("SecurityEvidenceCollector", fields: [collectedById], references: [id], onDelete: SetNull)

  @@index([controlId])
  @@index([collectedById])
}

model AccessReview {
  id          String             @id @default(cuid())
  tenantId    String
  title       String
  scope       String?            @db.Text
  systemName  String?
  status      AccessReviewStatus @default(PLANNED)
  dueDate     DateTime?
  ownerId     String?
  completedAt DateTime?
  notes       String?            @db.Text
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner  User?  @relation("AccessReviewOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  entries AccessReviewEntry[]

  @@index([tenantId])
  @@index([ownerId])
}

model AccessReviewEntry {
  id           String         @id @default(cuid())
  reviewId     String
  tenantId     String
  userName     String
  userEmail    String
  role         String?
  decision     AccessDecision @default(REVIEW)
  comment      String?        @db.Text
  decidedById  String?
  decidedAt    DateTime?
  createdAt    DateTime       @default(now())

  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  review    AccessReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  decidedBy User?        @relation("AccessReviewDecider", fields: [decidedById], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([reviewId])
  @@index([decidedById])
}

model CustomerFeedback {
  id               String          @id @default(cuid())
  tenantId         String
  recordedById     String
  recordedAt       DateTime        @default(now())
  customerName     String?
  customerCompany  String?
  contactEmail     String?
  contactPhone     String?
  source           FeedbackSource  @default(EMAIL)
  sentiment        FeedbackSentiment @default(POSITIVE)
  rating           Int?
  summary          String
  details          String?         @db.Text
  highlights       String?         @db.Text
  feedbackDate     DateTime?       @default(now())
  followUpStatus   FeedbackStatus  @default(NEW)
  followUpOwnerId  String?
  followUpNotes    String?         @db.Text
  linkedGoalId     String?
  linkedIncidentId String?
  attachments      String?         @db.Text
  sharedAt         DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recordedBy   User     @relation("FeedbackRecorder", fields: [recordedById], references: [id], onDelete: Cascade)
  followUpOwner User?   @relation("FeedbackFollowUpOwner", fields: [followUpOwnerId], references: [id], onDelete: SetNull)
  goal         Goal?    @relation(fields: [linkedGoalId], references: [id], onDelete: SetNull)
  incident     Incident? @relation(fields: [linkedIncidentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([recordedAt])
  @@index([followUpStatus])
  @@index([followUpOwnerId])
  @@index([linkedGoalId])
}

// ============================================
// Measures/Actions
// ============================================

model Measure {
  id                String       @id @default(cuid())
  tenantId          String
  riskId            String?
  incidentId        String?
  auditId           String?
  goalId            String?
  environmentalAspectId String?
  title             String
  description       String?      @db.Text
  dueAt             DateTime
  responsibleId     String
  status            ActionStatus @default(PENDING)
  completedAt       DateTime?
  effectiveness     ActionEffectiveness @default(NOT_EVALUATED)
  effectivenessNote String?      @db.Text
  followUpFrequency ControlFrequency? @default(ANNUAL)
  costEstimate      Int?
  benefitEstimate   Int?
  category          MeasureCategory @default(CORRECTIVE)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  risk        Risk?     @relation(fields: [riskId], references: [id])
  incident    Incident? @relation(fields: [incidentId], references: [id])
  audit       Audit?    @relation(fields: [auditId], references: [id])
  goal        Goal?     @relation(fields: [goalId], references: [id])
  responsible User      @relation("MeasureResponsible", fields: [responsibleId], references: [id], onDelete: Cascade)
  environmentalAspect EnvironmentalAspect? @relation(fields: [environmentalAspectId], references: [id], onDelete: SetNull)
  inspectionFindings InspectionFinding[] @relation("InspectionFindingMeasure")

  @@index([tenantId])
  @@index([status])
  @@index([dueAt])
  @@index([riskId])
  @@index([incidentId])
  @@index([auditId])
  @@index([goalId])
  @@index([environmentalAspectId])
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  DONE
  OVERDUE
}

enum ActionEffectiveness {
  NOT_EVALUATED
  EFFECTIVE
  PARTIALLY_EFFECTIVE
  INEFFECTIVE
}

enum MeasureCategory {
  CORRECTIVE
  PREVENTIVE
  IMPROVEMENT
  MITIGATION
}

// ============================================
// Environmental Management (ISO 14001)
// ============================================

model EnvironmentalAspect {
  id                 String                       @id @default(cuid())
  tenantId           String
  title              String
  description        String?                      @db.Text
  process            String?
  location           String?
  category           EnvironmentalAspectCategory  @default(RESOURCE_USE)
  impactType         EnvironmentalImpactType      @default(NEGATIVE)
  severity           Int
  likelihood         Int
  significanceScore  Int
  legalRequirement   String?                      @db.Text
  controlMeasures    String?                      @db.Text
  monitoringMethod   String?
  monitoringFrequency ControlFrequency?           @default(ANNUAL)
  ownerId            String?
  goalId             String?
  status             EnvironmentalAspectStatus    @default(ACTIVE)
  nextReviewDate     DateTime?
  lastMeasurementDate DateTime?
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner       User?        @relation("EnvironmentalAspectOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  goal        Goal?        @relation(fields: [goalId], references: [id], onDelete: SetNull)
  measurements EnvironmentalMeasurement[]
  measures     Measure[]

  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([significanceScore])
  @@index([ownerId])
  @@index([goalId])
}

model EnvironmentalMeasurement {
  id              String                         @id @default(cuid())
  tenantId        String
  aspectId        String
  parameter       String
  unit            String?
  method          String?
  limitValue      Float?
  targetValue     Float?
  measuredValue   Float
  measurementDate DateTime
  status          EnvironmentalMeasurementStatus @default(COMPLIANT)
  notes           String?                        @db.Text
  responsibleId   String?
  attachmentKey   String?
  createdAt       DateTime                       @default(now())
  updatedAt       DateTime                       @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  aspect      EnvironmentalAspect @relation(fields: [aspectId], references: [id], onDelete: Cascade)
  responsible User?               @relation("EnvironmentalMeasurementResponsible", fields: [responsibleId], references: [id], onDelete: SetNull)

  @@index([aspectId])
  @@index([measurementDate])
  @@index([status])
  @@index([responsibleId])
}

enum EnvironmentalAspectCategory {
  RESOURCE_USE
  ENERGY
  WATER
  WASTE
  EMISSIONS
  BIODIVERSITY
  OTHER
}

enum EnvironmentalImpactType {
  POSITIVE
  NEGATIVE
}

enum EnvironmentalAspectStatus {
  ACTIVE
  MONITORED
  CLOSED
}

enum EnvironmentalMeasurementStatus {
  COMPLIANT
  WARNING
  NON_COMPLIANT
}

// ============================================
// Incidents & Deviations
// ============================================

model Incident {
  id                  String       @id @default(cuid())
  tenantId            String
  type                IncidentType
  title               String
  description         String       @db.Text
  severity            Int          // 1-5 (ISO 9001: Alvorlighetsgrad)
  occurredAt          DateTime
  reportedBy          String
  responsibleId       String?      // Ansvarlig for oppfølging av avviket
  location            String?
  witnessName         String?
  immediateAction     String?      @db.Text // ISO 9001: Umiddelbare tiltak
  rootCause           String?      @db.Text // ISO 9001: Årsaksanalyse
  contributingFactors String?      @db.Text
  investigatedBy      String?
  investigatedAt      DateTime?
  customerName        String?
  customerEmail       String?
  customerPhone       String?
  customerTicketId    String?
  responseDeadline    DateTime?
  customerSatisfaction Int?
  status              IncidentStatus @default(OPEN)
  stage               IncidentStage  @default(REPORTED)
  closedBy            String?
  closedAt            DateTime?
  effectivenessReview String?      @db.Text // ISO 9001: Effektivitetsvurdering
  lessonsLearned      String?      @db.Text // ISO 9001: Læringspunkter
  injuryType          String?
  medicalAttentionRequired Boolean @default(false)
  lostTimeMinutes     Int?
  riskReferenceId     String?
  measureEffectiveness ActionEffectiveness? @default(NOT_EVALUATED)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  measures    Measure[]
  attachments Attachment[]
  customerFeedbacks CustomerFeedback[]
  risk        Risk?        @relation("IncidentRiskReference", fields: [riskReferenceId], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([occurredAt])
  @@index([severity])
  @@index([responsibleId])
  @@index([riskReferenceId])
}

enum IncidentType {
  AVVIK
  NESTEN
  SKADE
  MILJO
  KVALITET
  HMS
  CUSTOMER
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  ACTION_TAKEN
  CLOSED
}

enum IncidentStage {
  REPORTED
  UNDER_REVIEW
  ROOT_CAUSE
  ACTIONS_DEFINED
  ACTIONS_COMPLETE
  VERIFIED
}

// ============================================
// Training & Competence
// ============================================

model Training {
  id              String    @id @default(cuid())
  tenantId        String
  userId          String
  courseKey       String    // Unik ID for kurset (f.eks. "first-aid", "forklift")
  title           String    // "Førstehjelp", "Truckførerbevis"
  provider        String    // "Røde Kors", "BHT", "Internt"
  description     String?   @db.Text
  completedAt     DateTime? // ISO 9001: Når ble opplæringen fullført
  validUntil      DateTime? // For kurs med utløpsdato
  proofDocKey     String?   // ISO 9001: Dokumentert bevis (sertifikat PDF/bilde)
  isRequired      Boolean   @default(false) // Obligatorisk for alle/visse roller
  effectiveness   String?   @db.Text // ISO 9001: Evaluering av effektivitet
  evaluatedBy     String?
  evaluatedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([courseKey])
  @@index([validUntil])
  @@index([completedAt])
}

// Kursmal/template som definerer hvilke kurs en tenant bruker
model CourseTemplate {
  id              String   @id @default(cuid())
  tenantId        String?  // Null = globalt kurs, String = tenant-spesifikt
  courseKey       String   // Unik nøkkel (f.eks. "first-aid", "forklift")
  title           String   // "Førstehjelp", "Truckførerbevis"
  description     String?  @db.Text
  provider        String?  // Standard leverandør (f.eks. "Røde Kors")
  isRequired      Boolean  @default(false) // Obligatorisk for alle
  validityYears   Int?     // Hvor lenge er kurset gyldig (null = ikke utløpsdato)
  isGlobal        Boolean  @default(false) // Globalt standard HMS-kurs
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, courseKey])
  @@index([tenantId])
  @@index([isGlobal])
  @@index([isActive])
}

// ============================================
// Audits (ISO 9001 - 9.2 Internrevisjon)
// ============================================

model Audit {
  id              String      @id @default(cuid())
  tenantId        String
  title           String      // "Q1 2024 Internrevisjon"
  auditType       AuditType   @default(INTERNAL)
  scope           String      @db.Text // ISO 9001: Revisjonens omfang
  criteria        String      @db.Text // ISO 9001: Revisjonskriterier (hvilke krav)
  leadAuditorId   String      // ISO 9001: Hovedrevisor (objektivitet)
  teamMemberIds   String?     @db.Text // JSON array av bruker-IDer
  scheduledDate   DateTime    // ISO 9001: Planlagt dato
  completedAt     DateTime?   // ISO 9001: Når revisjon ble fullført
  area            String      // Område som revideres (HMS, Kvalitet, etc)
  department      String?     // Avdeling (hvis aktuelt)
  status          AuditStatus @default(PLANNED)
  summary         String?     @db.Text // Oppsummering av revisjon
  conclusion      String?     @db.Text // Konklusjon og anbefaling
  reportKey       String?     // PDF-rapport i storage
  approvedBy      String?     // Hvem som godkjente revisjonen
  approvedAt      DateTime?   // Når revisjonen ble godkjent
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  findings AuditFinding[]
  measures Measure[]
  riskAuditLinks RiskAuditLink[]

  @@index([tenantId])
  @@index([scheduledDate])
  @@index([status])
  @@index([auditType])
  @@index([leadAuditorId])
}

enum AuditType {
  INTERNAL       // Internrevisjon (ISO 9001: 9.2)
  EXTERNAL       // Ekstern revisjon (kunde, sertifisering)
  SUPPLIER       // Leverandørrevisjon
  CERTIFICATION  // Sertifiseringsrevisjon (ISO 9001)
}

enum AuditStatus {
  PLANNED      // Planlagt
  IN_PROGRESS  // Pågår
  COMPLETED    // Fullført
  APPROVED     // Godkjent
  CANCELLED    // Avbrutt
}

model AuditFinding {
  id               String        @id @default(cuid())
  auditId          String
  findingType      FindingType   // ISO 9001: Større/mindre avvik, observasjon
  clause           String        // ISO 9001 klausul (f.eks. "7.2", "9.1")
  description      String        @db.Text // Beskrivelse av funn
  evidence         String        @db.Text // ISO 9001: Bevis/observasjon
  requirement      String        @db.Text // Hvilket krav er ikke oppfylt
  responsibleId    String        // Ansvarlig for korrigerende tiltak
  dueDate          DateTime?     // Frist for lukking
  correctiveAction String?       @db.Text // ISO 9001: Korrigerende tiltak
  rootCause        String?       @db.Text // ISO 9001: Årsaksanalyse
  status           FindingStatus @default(OPEN)
  closedAt         DateTime?
  verifiedById     String?       // Hvem som verifiserte lukkingen
  verifiedAt       DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([status])
  @@index([findingType])
  @@index([responsibleId])
  @@index([dueDate])
}

enum FindingType {
  MAJOR_NC     // Større avvik (Major Non-Conformity)
  MINOR_NC     // Mindre avvik (Minor Non-Conformity)
  OBSERVATION  // Observasjon (potensielt problem)
  STRENGTH     // Styrke (god praksis)
}

enum FindingStatus {
  OPEN         // Åpen
  IN_PROGRESS  // Under arbeid
  RESOLVED     // Løst (venter verifikasjon)
  VERIFIED     // Verifisert lukket
}

// ============================================
// Goals & KPIs (ISO 9001 - 6.2 & 9.1)
// ============================================

model Goal {
  id              String       @id @default(cuid())
  tenantId        String
  title           String       // "Reduser arbeidsskader med 50%"
  description     String?      @db.Text
  category        GoalCategory @default(QUALITY) // HMS, Kvalitet, Miljø, etc
  targetValue     Float?       // Målverdi (f.eks. 50 for "50% reduksjon")
  currentValue    Float?       // Nåværende verdi (oppdateres ved måling)
  unit            String?      // Enhet (%, antall, timer, NOK, etc)
  baseline        Float?       // Utgangspunkt for måling
  year            Int          // Hvilket år gjelder målet?
  quarter         Int?         // Hvilket kvartal? (1-4, null = hele året)
  startDate       DateTime?    // Startdato
  deadline        DateTime?    // Sluttdato/frist
  ownerId         String       // Ansvarlig for målet (ISO 9001: Ansvar)
  status          GoalStatus   @default(ACTIVE)
  measurements    KpiMeasurement[] // Målinger over tid
  actions         Measure[]    // Tiltak knyttet til målet
  environmentalAspects EnvironmentalAspect[]
  risks           Risk[]       @relation("RiskGoal")
  customerFeedback CustomerFeedback[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([year])
  @@index([quarter])
  @@index([status])
  @@index([category])
  @@index([ownerId])
}

enum GoalCategory {
  QUALITY      // Kvalitetsmål
  HMS          // Helse, miljø, sikkerhet
  ENVIRONMENT  // Miljømål
  CUSTOMER     // Kundetilfredshet
  EFFICIENCY   // Effektivitet/produktivitet
  FINANCE      // Økonomiske mål
  COMPETENCE   // Kompetanseutvikling
  OTHER        // Annet
}

enum GoalStatus {
  ACTIVE       // Aktivt mål
  ACHIEVED     // Oppnådd
  AT_RISK      // I risiko (ikke på sporet)
  FAILED       // Ikke oppnådd
  ARCHIVED     // Arkivert
}

// Målinger/KPI-verdier over tid (ISO 9001: 9.1 Overvåking og måling)
model KpiMeasurement {
  id              String          @id @default(cuid())
  goalId          String
  tenantId        String
  value           Float           // Målt verdi
  measurementDate DateTime        // Når ble målingen tatt?
  measurementType MeasurementType @default(MANUAL)
  comment         String?         @db.Text // Kommentar til målingen
  measuredById    String?         // Hvem målte (hvis manuell)
  source          String?         // Kilde (hvis automatisk, f.eks. "incidents_count")
  createdAt       DateTime        @default(now())

  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([tenantId])
  @@index([measurementDate])
}

enum MeasurementType {
  MANUAL      // Manuell registrering
  AUTOMATIC   // Automatisk fra systemet
  CALCULATED  // Beregnet fra andre data
}

// ============================================
// Chemicals & Environment (Stoffkartotek)
// ============================================

model Chemical {
  id               String          @id @default(cuid())
  tenantId         String
  productName      String          // Produktnavn
  supplier         String?         // Leverandør
  casNumber        String?         // CAS-nummer
  hazardClass      String?         // Fareklasse (GHS/CLP)
  hazardStatements String?         @db.Text // H-setninger (H226, H315, etc)
  precautionaryStatements String?  @db.Text // P-setninger (P210, P261, etc)
  warningPictograms String?        @db.Text // JSON array av faresymboler (filnavn)
  requiredPPE      String?         @db.Text // JSON array av påkrevd PPE (ISO 7010)
  sdsKey           String?         // Sikkerhetsdatablad (PDF) i storage
  sdsVersion       String?         // Versjon av sikkerhetsdatablad
  sdsDate          DateTime?       // Dato for sikkerhetsdatablad
  nextReviewDate   DateTime?       // Neste revisjonsdata for datablad
  location         String?         // Lagringssted
  quantity         Float?          // Mengde
  unit             String?         // Enhet (liter, kg, etc)
  status           ChemicalStatus  @default(ACTIVE)
  notes            String?         @db.Text // Notater/kommentarer
  lastVerifiedAt   DateTime?       // Sist verifisert i revisjon
  lastVerifiedBy   String?         // Hvem verifiserte sist
  
  // ECHA/AI-berikede data (automatisk)
  ecNumber         String?         // EC-nummer fra ECHA
  isCMR            Boolean         @default(false) // Carcinogenic, Mutagenic, Reprotoxic
  isSVHC           Boolean         @default(false) // Substance of Very High Concern
  containsIsocyanates Boolean      @default(false) // Inneholder diisocyanater - krever spesialkurs
  reachStatus      String?         // REACH-status
  hazardLevel      Int?            // 1-5 (beregnet fra H-setninger)
  substitutionPriority String?     // HIGH, MEDIUM, LOW
  autoSuggestedAlternatives String? @db.Text // JSON array av foreslåtte alternativer
  lastEchaSync     DateTime?       // Sist synkronisert med ECHA
  aiExtractedData  String?         @db.Text // JSON med AI-ekstraherte data fra SDS
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant     Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  riskLinks  RiskChemicalLink[] // Kobling til risikovurderinger

  @@index([tenantId])
  @@index([status])
  @@index([nextReviewDate])
  @@index([casNumber])
  @@index([isCMR])
  @@index([isSVHC])
  @@index([containsIsocyanates])
  @@index([hazardLevel])
}

enum ChemicalStatus {
  ACTIVE      // I bruk
  PHASED_OUT  // Utfases
  ARCHIVED    // Ikke lenger i bruk
}

// ============================================
// Attachments
// ============================================

model Attachment {
  id         String   @id @default(cuid())
  tenantId   String
  incidentId String?
  objectType String?
  objectId   String?
  fileKey    String
  name       String
  mime       String
  size       Int?
  createdAt  DateTime @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  incident Incident? @relation(fields: [incidentId], references: [id])

  @@index([tenantId])
  @@index([objectType, objectId])
  @@index([incidentId])
}

// ============================================
// Audit Log (COMPLIANCE LOGGING)
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  action    String   // DOCUMENT_UPLOADED, DOCUMENT_APPROVED, DOCUMENT_DELETED, etc.
  resource  String?  // Document:abc123
  metadata  String?  @db.Text // JSON med detaljer
  ipAddress String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([ipAddress])
}

// ============================================================================
// VERNERUNDE / INSPEKSJONER MODULE
// ============================================================================

model Inspection {
  id               String            @id @default(cuid())
  tenantId         String
  title            String
  description      String?           @db.Text
  type             InspectionType    @default(VERNERUNDE)
  status           InspectionStatus  @default(PLANNED)
  scheduledDate    DateTime
  completedDate    DateTime?
  location         String?
  area             String?
  riskCategory     RiskCategory?
  templateId       String?           // Gammelt system: InspectionTemplate
  formTemplateId   String?           // Nytt system: FormTemplate (skjemabygger)
  formSubmissionId String?           // Kobling til utfylt skjema
  conductedBy      String            // userId
  participants     String?           @db.Text // JSON array of userIds
  durationMinutes  Int?
  followUpById     String?
  nextInspection   DateTime?
  findings         InspectionFinding[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template        InspectionTemplate? @relation("TemplateInspections", fields: [templateId], references: [id], onDelete: SetNull)
  formTemplate    FormTemplate?       @relation("InspectionFormTemplates", fields: [formTemplateId], references: [id], onDelete: SetNull)
  formSubmission  FormSubmission?     @relation("InspectionFormSubmission", fields: [formSubmissionId], references: [id], onDelete: SetNull)
  
  @@index([tenantId])
  @@index([scheduledDate])
  @@index([status])
  @@index([type])
  @@index([templateId])
  @@index([formTemplateId])
  @@index([formSubmissionId])
  @@index([riskCategory])
  @@index([nextInspection])
}

model InspectionTemplate {
  id          String   @id @default(cuid())
  tenantId    String?
  name        String
  description String? @db.Text
  category    String?
  riskCategory RiskCategory?
  checklist   Json?
  isGlobal    Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant?      @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  inspections Inspection[] @relation("TemplateInspections")
  risks       Risk[]       @relation("RiskInspectionTemplate")

  @@index([tenantId])
  @@index([category])
  @@index([riskCategory])
  @@index([isGlobal])
}

model InspectionFinding {
  id            String           @id @default(cuid())
  inspectionId  String
  title         String
  description   String           @db.Text
  severity      Int              // 1-5 (1=Lav, 5=Kritisk)
  location      String?
  imageKeys     String?          @db.Text // JSON array of R2 keys
  status        InspectionFindingStatus    @default(OPEN)
  responsibleId String?
  dueDate       DateTime?
  resolvedAt    DateTime?
  resolutionNotes String?        @db.Text
  linkedRiskId  String?
  linkedMeasureId String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  linkedRisk Risk? @relation("InspectionFindingRisk", fields: [linkedRiskId], references: [id])
  linkedMeasure Measure? @relation("InspectionFindingMeasure", fields: [linkedMeasureId], references: [id])
  
  @@index([inspectionId])
  @@index([status])
  @@index([responsibleId])
  @@index([linkedRiskId])
  @@index([linkedMeasureId])
}

enum InspectionType {
  VERNERUNDE
  HMS_INSPEKSJON
  BRANNØVELSE
  SHA_PLAN
  SIKKERHETSVANDRING
  ANDRE
}

enum InspectionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InspectionFindingStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// ============================================================================
// DIGITAL FORMS MODULE (Planlagt - implementeres senere)
// ============================================================================
// Dette er konkurransefordelen som de fleste HMS-systemer mangler!
// Admin kan lage egne skjemaer (HMS morgenmøte, inspeksjoner, etc.) som
// brukere fyller ut digitalt med signatur. Se FORMS.md for full dokumentasjon.

model FormTemplate {
  id                String            @id @default(cuid())
  tenantId          String?
  title             String            // "HMS Morgenmøte"
  description       String?           @db.Text
  category          FormCategory      @default(CUSTOM)
  isActive          Boolean           @default(true)
  requiresSignature Boolean           @default(true)
  requiresApproval  Boolean           @default(false)
  isRecurring       Boolean           @default(false)
  recurrenceRule    String?           @db.Text // RRULE format (daglig/ukentlig)
  isGlobal          Boolean           @default(false) // For globale/system-templates
  
  // Tilgangsstyring
  accessType        AccessType        @default(ALL) // Hvem har tilgang
  allowedRoles      String?           @db.Text // JSON array: ["ADMIN", "HMS"]
  allowedUsers      String?           @db.Text // JSON array: ["userId1", "userId2"]
  
  createdBy         String
  fields            FormField[]
  submissions       FormSubmission[]
  inspections       Inspection[]      @relation("InspectionFormTemplates")
  tenant            Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([tenantId])
  @@index([createdBy])
  @@index([category])
  @@index([isActive])
  @@index([accessType])
}

enum AccessType {
  ALL            // Alle i tenanten
  ROLES          // Spesifikke roller
  USERS          // Spesifikke brukere
  ROLES_AND_USERS // Kombinasjon av roller og brukere
}

enum FormCategory {
  MEETING       // Møtereferater
  INSPECTION    // Inspeksjoner / Vernerunder
  INCIDENT      // Hendelsesrapporter
  RISK          // Risikovurderinger
  TRAINING      // Opplæring
  CHECKLIST     // Sjekklister
  WELLBEING     // Psykososiale skjemaer (ISO 45003)
  BCM           // Beredskaps- og kontinuitetsplaner (ISO 22301)
  COMPLAINT     // Kundeklager (ISO 10002)
  CUSTOM        // Egendefinert
}

model FormField {
  id               String          @id @default(cuid())
  formTemplateId   String
  fieldType        FieldType
  label            String
  helpText         String?         @db.Text
  placeholder      String?
  isRequired       Boolean         @default(false)
  order            Int             // Sortering (1, 2, 3...)
  validation       String?         @db.Text // JSON: { min: 5, max: 100 }
  options          String?         @db.Text // JSON: ["Ja", "Nei", "Vet ikke"]
  conditionalLogic String?         @db.Text // JSON: Vis hvis felt X = Y
  formTemplate     FormTemplate    @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  values           FormFieldValue[]
  createdAt        DateTime        @default(now())
  
  @@index([formTemplateId])
  @@index([order])
}

enum FieldType {
  TEXT          // Kort tekst
  TEXTAREA      // Lang tekst
  NUMBER        // Tall
  DATE          // Dato
  DATETIME      // Dato + tid
  CHECKBOX      // Ja/Nei
  RADIO         // Radioknapper
  SELECT        // Dropdown
  FILE          // Filopplasting
  SIGNATURE     // Digital signatur
  LIKERT_SCALE  // 1-5 skala (Svært uenig → Svært enig)
  SECTION_HEADER // Overskrift/seksjon i skjema
}

model FormSubmission {
  id              String            @id @default(cuid())
  formTemplateId  String
  tenantId        String
  submittedById   String
  status          SubmissionStatus  @default(DRAFT)
  signedAt        DateTime?
  approvedById    String?
  approvedAt      DateTime?
  fieldValues     FormFieldValue[]
  inspections     Inspection[]      @relation("InspectionFormSubmission")
  metadata        String?           @db.Text // JSON: IP, location, etc.
  formTemplate    FormTemplate      @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([tenantId])
  @@index([submittedById])
  @@index([formTemplateId])
  @@index([status])
  @@index([createdAt])
}

enum SubmissionStatus {
  DRAFT         // Kladd (ikke sendt inn)
  SUBMITTED     // Sendt inn, venter godkjenning
  APPROVED      // Godkjent av leder
  REJECTED      // Avvist
}

model FormFieldValue {
  id           String         @id @default(cuid())
  submissionId String
  fieldId      String
  value        String?        @db.Text // JSON for komplekse verdier
  fileKey      String?        // Hvis file upload
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  field        FormField      @relation(fields: [fieldId], references: [id])
  
  @@index([submissionId])
  @@index([fieldId])
}

// ============================================
// Blog & SEO
// ============================================

model BlogPost {
  id              String        @id @default(cuid())
  title           String
  slug            String        @unique
  excerpt         String        @db.Text // Kort beskrivelse (meta description)
  content         String        @db.LongText // Markdown eller rich text
  coverImage      String?       @db.Text // URL til hovedbilde (signerte URLs kan være lange)
  
  // SEO
  metaTitle       String?       // Custom SEO title (default: title)
  metaDescription String?       @db.Text // Custom meta description (default: excerpt)
  keywords        String?       @db.Text // Kommaseparert liste med keywords
  
  // Organisering
  category        BlogCategory? @relation(fields: [categoryId], references: [id])
  categoryId      String?
  tags            BlogTag[]
  
  // Publisering
  status          PostStatus    @default(DRAFT)
  publishedAt     DateTime?
  scheduledFor    DateTime?     // Planlagt publisering
  
  // Forfatter
  authorId        String
  author          User          @relation(fields: [authorId], references: [id])
  
  // Analytics
  viewCount       Int           @default(0)
  
  // Relaterte artikler (valgfritt)
  relatedPosts    String?       @db.Text // JSON array med post IDs
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([categoryId])
  @@index([authorId])
}

enum PostStatus {
  DRAFT       // Kladd
  PUBLISHED   // Publisert
  SCHEDULED   // Planlagt
  ARCHIVED    // Arkivert
}

model BlogCategory {
  id          String      @id @default(cuid())
  name        String      @unique
  slug        String      @unique
  description String?     @db.Text
  color       String?     // Hex color for UI
  posts       BlogPost[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([slug])
}

model BlogTag {
  id        String      @id @default(cuid())
  name      String      @unique
  slug      String      @unique
  posts     BlogPost[]
  createdAt DateTime    @default(now())
  
  @@index([slug])
}

// ============================================
// Ledelsens Gjennomgang (Management Review)
// ============================================

model ManagementReview {
  id                    String                @id @default(cuid())
  tenantId              String
  title                 String
  reviewDate            DateTime
  period                String                // "Q1 2025", "H1 2025", "2025"
  conductedBy           String                // userId
  participants          String?               @db.Text // JSON array of userIds
  
  // Input data (JSON)
  hmsGoalsReview        String?               @db.Text // Gjennomgang av HMS-mål
  incidentStatistics    String?               @db.Text // Avvik og hendelser statistikk
  riskReview            String?               @db.Text // Risikovurderinger status
  auditResults          String?               @db.Text // Revisjoner og funn
  trainingStatus        String?               @db.Text // Opplæringsstatus
  resourcesReview       String?               @db.Text // Ressurser og budsjett
  externalChanges       String?               @db.Text // Eksterne endringer (lover, etc)
  wellbeingSummary      String?               @db.Text // Psykososialt arbeidsmiljø oppsummering
  
  // Output data
  conclusions           String?               @db.Text // Konklusjoner
  decisions             String?               @db.Text // JSON array of beslutninger
  actionPlan            String?               @db.Text // JSON array of tiltak
  nextReviewDate        DateTime?
  
  // Meta
  status                ManagementReviewStatus @default(PLANNED)
  approvedBy            String?               // userId
  approvedAt            DateTime?
  notes                 String?               @db.Text
  attachments           String?               @db.Text // JSON array of file keys
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([reviewDate])
  @@index([status])
}

enum ManagementReviewStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  APPROVED
}

// ============================================
// AMU/VO (Arbeidsmiljøutvalg/Verneombud)
// ============================================

model Meeting {
  id                String              @id @default(cuid())
  tenantId          String
  type              MeetingType         @default(AMU)
  title             String
  scheduledDate     DateTime
  location          String?
  meetingLink       String?             // Teams/Zoom link
  
  // Agenda
  agenda            String?             @db.Text // JSON array of agenda items
  
  // Meeting notes
  summary           String?             @db.Text
  notes             String?             @db.Text
  
  // Meta
  status            MeetingStatus       @default(PLANNED)
  startedAt         DateTime?
  completedAt       DateTime?
  organizer         String              // userId
  minuteTaker       String?             // Referent/protokollfører
  
  // Relations
  participants      MeetingParticipant[]
  decisions         MeetingDecision[]
  attachments       String?             @db.Text // JSON array of file keys
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([scheduledDate])
  @@index([type])
  @@index([status])
}

model MeetingParticipant {
  id              String   @id @default(cuid())
  meetingId       String
  userId          String?  // Kan være null for eksterne
  externalName    String?  // For eksterne deltakere
  externalEmail   String?
  role            ParticipantRole @default(MEMBER)
  attended        Boolean  @default(false)
  notes           String?  @db.Text
  
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user    User?   @relation("MeetingParticipants", fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([meetingId])
  @@index([userId])
}

model MeetingDecision {
  id              String          @id @default(cuid())
  meetingId       String
  decisionNumber  String          // "2025-01", "2025-02", etc.
  title           String
  description     String          @db.Text
  responsibleId   String?         // userId
  dueDate         DateTime?
  status          DecisionStatus  @default(PENDING)
  completedAt     DateTime?
  notes           String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  meeting     Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  responsible User?   @relation("MeetingDecisions", fields: [responsibleId], references: [id], onDelete: SetNull)
  
  @@index([meetingId])
  @@index([responsibleId])
  @@index([status])
  @@index([dueDate])
}

enum MeetingType {
  AMU             // Arbeidsmiljøutvalg
  VO              // Verneombud møte
  BHT             // Bedriftshelsetjeneste møte
  HMS_COMMITTEE   // HMS-utvalg
  OTHER
}

enum MeetingStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ParticipantRole {
  CHAIR           // Møteleder
  SECRETARY       // Referent
  MEMBER          // Medlem
  OBSERVER        // Observatør
}

enum DecisionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// Varsling (Whistleblowing)
// ============================================

model Whistleblowing {
  id              String              @id @default(cuid())
  tenantId        String
  caseNumber      String              @unique // "VAR-2025-001"
  accessCode      String              @unique // Tilgangskode for anonym oppfølging
  
  // Report details
  category        WhistleblowCategory
  title           String
  description     String              @db.Text
  occurredAt      DateTime?
  location        String?
  
  // Involved parties (anonymized)
  involvedPersons String?             @db.Text // Beskrivelse uten navn
  witnesses       String?             @db.Text
  
  // Reporter info (optional - kan være helt anonym)
  reporterName    String?
  reporterEmail   String?
  reporterPhone   String?
  isAnonymous     Boolean             @default(true)
  
  // Case handling
  status          WhistleblowStatus   @default(RECEIVED)
  severity        WhistleblowSeverity @default(MEDIUM)
  handledBy       String?             // userId
  assignedTo      String?             // userId
  
  // Investigation
  investigationNotes String?          @db.Text
  actions         String?             @db.Text // JSON array of actions taken
  outcome         String?             @db.Text
  closedReason    String?
  
  // Communication
  messages        WhistleblowMessage[]
  attachments     String?             @db.Text // JSON array of encrypted file keys
  
  // Meta
  receivedAt      DateTime            @default(now())
  acknowledgedAt  DateTime?
  investigatedAt  DateTime?
  closedAt        DateTime?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([caseNumber])
  @@index([accessCode])
  @@index([status])
  @@index([category])
  @@index([handledBy])
}

model WhistleblowMessage {
  id                String          @id @default(cuid())
  whistleblowingId  String
  sender            MessageSender   // REPORTER, HANDLER, SYSTEM
  senderUserId      String?         // Kun hvis sender er HANDLER
  message           String          @db.Text
  isInternal        Boolean         @default(false) // Kun synlig for admin
  readByReporter    Boolean         @default(false)
  
  createdAt         DateTime        @default(now())
  
  whistleblowing Whistleblowing @relation(fields: [whistleblowingId], references: [id], onDelete: Cascade)
  
  @@index([whistleblowingId])
  @@index([createdAt])
}

enum WhistleblowCategory {
  HARASSMENT          // Trakassering
  DISCRIMINATION      // Diskriminering
  WORK_ENVIRONMENT    // Arbeidsmiljø
  SAFETY              // HMS/Sikkerhet
  CORRUPTION          // Korrupsjon/Underslag
  ETHICS              // Etikk
  LEGAL               // Lovbrudd
  OTHER               // Annet
}

enum WhistleblowStatus {
  RECEIVED            // Mottatt
  ACKNOWLEDGED        // Bekreftet mottatt
  UNDER_INVESTIGATION // Under etterforskning
  ACTION_TAKEN        // Tiltak iverksatt
  RESOLVED            // Løst
  CLOSED              // Avsluttet
  DISMISSED           // Avvist
}

enum WhistleblowSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum MessageSender {
  REPORTER
  HANDLER
  SYSTEM
}

// ============================================
// Notifications (Real-time varsler)
// ============================================

model Notification {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  // Avvik/Hendelser
  NEW_INCIDENT           // Nytt avvik
  INCIDENT_UPDATED       // Avvik oppdatert
  INCIDENT_CLOSED        // Avvik lukket
  INCIDENT_OVERDUE       // Avvik ikke behandlet innen frist
  
  // Skjemaer
  FORM_SUBMITTED         // Skjema sendt inn
  FORM_APPROVED          // Skjema godkjent
  FORM_REJECTED          // Skjema avvist
  
  // Varsling (whistleblowing)
  WHISTLEBLOWING         // Ny varsling
  WHISTLEBLOWING_MSG     // Ny melding i varslingssak
  
  // Tiltak
  MEASURE_OVERDUE        // Tiltak forfalt
  MEASURE_ASSIGNED       // Tiltak tildelt deg
  MEASURE_DUE_SOON       // Tiltak forfaller snart (7 dager)
  MEASURE_REMINDER       // Påminnelse om tiltak som forfaller
  
  // Revisjoner
  AUDIT_SCHEDULED        // Revisjon planlagt
  AUDIT_REMINDER         // Påminnelse om revisjon
  AUDIT_FINDING_OPEN     // Revisjonsfunn ikke lukket
  
  // Opplæring
  TRAINING_DUE           // Opplæring forfaller snart
  TRAINING_EXPIRED       // Opplæring/sertifikat utløpt
  TRAINING_ASSIGNED      // Ny opplæring tildelt
  
  // Møter
  MEETING_REMINDER       // Påminnelse om møte
  MEETING_SCHEDULED      // Nytt møte planlagt
  
  // Vernerunder/Inspeksjoner
  INSPECTION_REMINDER    // Påminnelse om vernerunde/inspeksjon
  INSPECTION_SCHEDULED   // Vernerunde planlagt
  INSPECTION_OVERDUE     // Vernerunde ikke gjennomført
  INSPECTION_FINDING     // Nytt funn fra vernerunde
  
  // Risikoer
  RISK_REVIEW_DUE        // Risiko trenger gjennomgang
  RISK_HIGH_SCORE        // Høy risikoscore varsling
  RISK_CONTROL_DUE       // Risikokontroll forfaller
  
  // Dokumenter
  DOCUMENT_REVIEW_DUE    // Dokument trenger revisjon
  DOCUMENT_EXPIRED       // Dokument utløpt
  DOCUMENT_APPROVED      // Dokument godkjent
  
  // Kjemikalier/Stoffkartotek
  CHEMICAL_SDS_REVIEW    // SDS trenger oppdatering
  CHEMICAL_EXPIRED       // Kjemikalie-revisjon forfalt
  
  // Mål/KPI
  GOAL_AT_RISK           // Mål i fare
  GOAL_MEASUREMENT_DUE   // Tid for ny måling
  
  // Miljø
  ENVIRONMENTAL_LIMIT    // Miljømåling nær/over grense
  
  // Ledelsens gjennomgang
  MGMT_REVIEW_DUE        // Tid for ledelsens gjennomgang
  MGMT_REVIEW_SCHEDULED  // Ledelsens gjennomgang planlagt
  
  // System
  DAILY_DIGEST           // Daglig sammendrag
  WEEKLY_DIGEST          // Ukentlig sammendrag
  SYSTEM_ALERT           // Systemvarsel
}

// ============================================
// Scheduled Reminders (Planlagte påminnelser)
// ============================================

model ScheduledReminder {
  id              String            @id @default(cuid())
  tenantId        String
  userId          String            // Hvem som skal motta påminnelsen
  type            ReminderType
  entityType      String            // "Meeting", "Inspection", "Audit", "Measure"
  entityId        String            // ID til møte/inspeksjon/etc
  title           String            // Tittel på påminnelsen
  message         String?           @db.Text // Ekstra melding/beskrivelse
  scheduledFor    DateTime          // Når påminnelsen skal sendes
  sentAt          DateTime?         // Når påminnelsen ble sendt
  sentViaEmail    Boolean           @default(false)
  sentViaSms      Boolean           @default(false)
  status          ReminderStatus    @default(PENDING)
  error           String?           @db.Text
  createdAt       DateTime          @default(now())
  
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation("UserReminders", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@index([entityType, entityId])
}

enum ReminderType {
  // Møter og hendelser
  MEETING_UPCOMING        // Møte om X dager
  INSPECTION_UPCOMING     // Vernerunde om X dager
  AUDIT_UPCOMING          // Revisjon om X dager
  MGMT_REVIEW_UPCOMING    // Ledelsens gjennomgang om X dager
  
  // Frister
  MEASURE_DUE_SOON        // Tiltak forfaller snart
  TRAINING_EXPIRING       // Opplæring utløper snart
  DOCUMENT_REVIEW_SOON    // Dokument trenger revisjon snart
  CHEMICAL_REVIEW_SOON    // Kjemikalie/SDS trenger revisjon snart
  RISK_REVIEW_SOON        // Risiko trenger gjennomgang snart
  GOAL_MEASUREMENT_SOON   // Tid for KPI-måling snart
  
  // Periodiske
  DAILY_TASKS             // Daglige oppgaver
  WEEKLY_SUMMARY          // Ukentlig sammendrag
}

enum ReminderStatus {
  PENDING     // Venter på å bli sendt
  SENT        // Sendt vellykket
  FAILED      // Feilet
  CANCELLED   // Kansellert (f.eks. møte ble avlyst)
}

// ============================================
// BHT - Bedriftshelsetjeneste
// ============================================

// BHT-kunde registrering (kobling mellom BHT-leverandør og kunde-tenant)
model BhtClient {
  id                  String   @id @default(cuid())
  tenantId            String   // Kunden som får BHT-tjenester
  bhtProviderId       String?  // BHT-leverandørens tenant (null = HMS Nova selv)
  contractStartDate   DateTime // Avtalestart
  contractEndDate     DateTime? // Avtalens utløp
  packageType         BhtPackageType @default(BASIC) // Grunnpakke eller utvidet
  status              BhtClientStatus @default(ACTIVE)
  notes               String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assessments         BhtAssessment[]
  consultations       BhtConsultation[]
  amoMeetings         BhtAmoMeeting[]
  inspections         BhtInspection[]
  exposureAssessments BhtExposureAssessment[]
  annualReports       BhtAnnualReport[]

  @@unique([tenantId])
  @@index([status])
}

enum BhtPackageType {
  BASIC    // Grunnpakke
  EXTENDED // Utvidet pakke
}

enum BhtClientStatus {
  ACTIVE
  PAUSED
  TERMINATED
}

// 1. Årlig arbeidsmiljøkartlegging
model BhtAssessment {
  id                String   @id @default(cuid())
  bhtClientId       String
  year              Int      // Hvilket år kartleggingen gjelder
  status            BhtAssessmentStatus @default(DRAFT)
  
  // AI-foranalyse
  aiSuggestedRisks  String?  @db.Text // JSON: foreslåtte risikoer
  aiSuggestedIssues String?  @db.Text // JSON: foreslåtte avvik
  aiSuggestedActions String? @db.Text // JSON: foreslåtte tiltak
  aiGeneratedAt     DateTime?
  
  // Kundeinvolvering
  sentToCustomerAt  DateTime?
  customerConfirmedAt DateTime?
  customerComments  String?  @db.Text
  customerAdditions String?  @db.Text
  
  // BHT-vurdering
  bhtReviewedBy     String?  // Bruker-ID
  bhtReviewedAt     DateTime?
  bhtComments       String?  @db.Text
  adjustedRiskLevel String?  @db.Text // JSON: justert risikonivå
  adjustedActions   String?  @db.Text // JSON: justerte tiltak
  
  // Ferdig rapport
  finalReportUrl    String?
  completedAt       DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  bhtClient         BhtClient @relation(fields: [bhtClientId], references: [id], onDelete: Cascade)
  
  @@unique([bhtClientId, year])
  @@index([status])
  @@index([year])
}

enum BhtAssessmentStatus {
  DRAFT           // Utkast
  AI_ANALYZED     // AI-analyse ferdig
  SENT_TO_CUSTOMER // Sendt til kunde
  CUSTOMER_RESPONDED // Kunde har svart
  BHT_REVIEWED    // BHT har vurdert
  COMPLETED       // Ferdigstilt
}

// 2. HMS-rådgivning logg
model BhtConsultation {
  id              String   @id @default(cuid())
  bhtClientId     String
  consultationType BhtConsultationType
  
  // Hva ble spurt om
  topic           String
  description     String   @db.Text
  
  // Hva ble anbefalt
  recommendation  String   @db.Text
  
  // Metadata
  conductedBy     String   // Bruker-ID for BHT-rådgiver
  conductedAt     DateTime
  durationMinutes Int?     // Varighet i minutter
  method          BhtConsultationMethod
  
  // Begrensninger
  isWithinScope   Boolean  @default(true) // Innenfor grunnpakke-scope
  outOfScopeNotes String?  @db.Text // Hvis utenfor scope, hva ble henvist til
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bhtClient       BhtClient @relation(fields: [bhtClientId], references: [id], onDelete: Cascade)

  @@index([bhtClientId])
  @@index([conductedAt])
}

enum BhtConsultationType {
  ON_REQUEST      // På forespørsel
  ASSESSMENT_RELATED // I forbindelse med kartlegging
  OPERATIONAL_CHANGE // Ved endringer i drift
  FOLLOW_UP       // Oppfølging
}

enum BhtConsultationMethod {
  DIGITAL_MEETING // Digitalt møte
  PHONE           // Telefon
  WRITTEN         // Skriftlig i HMS Nova
  IN_PERSON       // Fysisk møte
}

// 3a. AMO-møte (Arbeidsmiljøorgan)
model BhtAmoMeeting {
  id              String   @id @default(cuid())
  bhtClientId     String
  year            Int
  
  // Forberedelse
  preparedIssues  String?  @db.Text // JSON: avvik fra HMS Nova
  preparedRisks   String?  @db.Text // JSON: risikovurderinger
  preparedSickLeave String? @db.Text // JSON: sykefraværsstatistikk
  aiSuggestedAgenda String? @db.Text // JSON: AI-foreslåtte saker
  
  // Gjennomføring
  meetingDate     DateTime?
  meetingType     BhtMeetingType @default(DIGITAL)
  participants    String?  @db.Text // JSON: deltakere
  agenda          String?  @db.Text // Endelig agenda
  
  // Referat
  minutes         String?  @db.Text
  decisions       String?  @db.Text // JSON: beslutninger
  
  // Tiltak
  actionsRegistered Boolean @default(false)
  
  status          BhtAmoStatus @default(PLANNED)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bhtClient       BhtClient @relation(fields: [bhtClientId], references: [id], onDelete: Cascade)

  @@unique([bhtClientId, year])
  @@index([status])
}

enum BhtMeetingType {
  DIGITAL
  IN_PERSON
  HYBRID
}

enum BhtAmoStatus {
  PLANNED
  PREPARED
  CONDUCTED
  MINUTES_DONE
  COMPLETED
}

// 3b. BHT-vernerunde (alternativ til AMO)
model BhtInspection {
  id              String   @id @default(cuid())
  bhtClientId     String
  year            Int
  
  // Forberedelse
  aiGeneratedChecklist String? @db.Text // JSON: AI-generert sjekkliste
  basedOnIndustry String?  // Bransje
  basedOnPreviousFindings String? @db.Text // Tidligere funn
  
  // Gjennomføring
  inspectionDate  DateTime?
  inspectionType  BhtMeetingType @default(DIGITAL)
  participants    String?  @db.Text // JSON: deltakere
  
  // Funn
  findings        String?  @db.Text // JSON: avvik og funn
  improvements    String?  @db.Text // JSON: forbedringsforslag
  
  // Rapport
  reportUrl       String?
  actionsRegistered Boolean @default(false)
  
  status          BhtInspectionStatus @default(PLANNED)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bhtClient       BhtClient @relation(fields: [bhtClientId], references: [id], onDelete: Cascade)

  @@unique([bhtClientId, year])
  @@index([status])
}

enum BhtInspectionStatus {
  PLANNED
  PREPARED
  CONDUCTED
  REPORT_DONE
  COMPLETED
}

// 4. Eksponeringsvurdering
model BhtExposureAssessment {
  id              String   @id @default(cuid())
  bhtClientId     String
  year            Int
  
  // Datagrunnlag
  chemicalInventory String? @db.Text // JSON: stoffkartotek
  jobDescriptions String?  @db.Text // JSON: stillingsbeskrivelser
  assessmentData  String?  @db.Text // JSON: kartleggingsdata
  
  // AI-vurdering
  aiExposureAnalysis String? @db.Text // JSON: mulig eksponering
  aiRiskLevel     String?  // Risikonivå
  aiGeneratedAt   DateTime?
  
  // BHT-konklusjon
  bhtReviewedBy   String?
  bhtReviewedAt   DateTime?
  conclusion      BhtExposureConclusion?
  furtherActionNeeded Boolean @default(false)
  furtherActionNotes String? @db.Text // Hva anbefales
  
  // Dokumentasjon
  assessmentNotes String?  @db.Text
  
  status          BhtExposureStatus @default(DRAFT)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bhtClient       BhtClient @relation(fields: [bhtClientId], references: [id], onDelete: Cascade)

  @@unique([bhtClientId, year])
  @@index([status])
}

enum BhtExposureConclusion {
  SUFFICIENT      // Tilstrekkelig vurdert
  NEEDS_FOLLOWUP  // Anbefaler videre kartlegging
}

enum BhtExposureStatus {
  DRAFT
  AI_ANALYZED
  BHT_REVIEWED
  COMPLETED
}

// 5. Årlig BHT-oppsummering og plan
model BhtAnnualReport {
  id              String   @id @default(cuid())
  bhtClientId     String
  year            Int
  
  // Samlet grunnlag
  assessmentSummary String? @db.Text // Oppsummering av kartlegging
  consultationsSummary String? @db.Text // Oppsummering av rådgivning
  amoOrInspectionSummary String? @db.Text // AMO/Vernerunde oppsummering
  exposureSummary String?  @db.Text // Eksponeringsvurdering oppsummering
  
  // AI-utkast
  aiDraftReport   String?  @db.Text // AI-generert utkast
  aiSuggestedActions String? @db.Text // Foreslåtte tiltak
  aiNextYearPlan  String?  @db.Text // Plan for neste år
  aiGeneratedAt   DateTime?
  
  // BHT kvalitetssikring
  bhtReviewedBy   String?
  bhtReviewedAt   DateTime?
  bhtAdjustments  String?  @db.Text // Justeringer gjort
  
  // Ferdig rapport
  finalReportUrl  String?
  
  // Ledelsens gjennomgang
  managementReviewedAt DateTime?
  managementReviewedBy String? // Kunde-side leder
  
  // Kvalitetssjekk
  checkAssessmentDone Boolean @default(false)
  checkConsultationsDone Boolean @default(false)
  checkAmoOrInspectionDone Boolean @default(false)
  checkExposureDone Boolean @default(false)
  checkReportDone Boolean @default(false)
  checkActionsDone Boolean @default(false)
  
  status          BhtReportStatus @default(DRAFT)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bhtClient       BhtClient @relation(fields: [bhtClientId], references: [id], onDelete: Cascade)

  @@unique([bhtClientId, year])
  @@index([status])
  @@index([year])
}

enum BhtReportStatus {
  DRAFT           // Utkast
  AI_GENERATED    // AI-utkast ferdig
  BHT_REVIEWED    // BHT har gjennomgått
  FINAL           // Ferdigstilt
  MANAGEMENT_REVIEWED // Ledelsen har gjennomgått
  COMPLETED       // Alt fullført
}

// ============================================
// Navigation Menu Configuration
// ============================================

model NavigationItem {
  id              String   @id @default(cuid())
  tenantId        String?  // Null = global default, String = tenant-specific
  key             String   // Unique identifier (e.g. "dashboard", "documents")
  label           String   // Display label or i18n key (e.g. "nav.dashboard")
  icon            String?  // Icon name (e.g. "LayoutDashboard")
  href            String   // Navigation path (e.g. "/dashboard")
  permission      String   // Permission key to check (e.g. "dashboard")
  isSimpleMode    Boolean  @default(false) // Show in simple mode
  isActive        Boolean  @default(true)  // Is this menu item active
  order           Int      @default(0)     // Sort order
  parentKey       String?  // For nested menus (null = top level)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([isActive])
  @@index([order])
}
